- name: Display final status
  ansible.builtin.debug:
    msg:
      - "{{ '=' * 60 }}"
      - "{{ ' ' * 20 }}ğŸ‰ RETH SETUP COMPLETE {{ ' ' * 20 }}"
      - "{{ '=' * 60 }}"
      - "âœ… Service status: {{ 'Running' if reth_health_check.status == 200 else 'Not responding' }}"
      - "ğŸŒ HTTP endpoint: http://127.0.0.1:8545"
      - "ğŸ”Œ WebSocket endpoint: ws://127.0.0.1:8546"
      - "ğŸ“Š Metrics endpoint: http://127.0.0.1:9001"
      - "ğŸ“ Data directory: {{ reth_data_dir }}"
      - "{{ '=' * 60 }}"

- name: Check JWT file
  ansible.builtin.stat:
    path: /secrets/jwtsecret
  register: jwt_file

- name: Display JWT file status
  ansible.builtin.debug:
    msg: "JWT secret file exists: {{ jwt_file.stat.exists }}, last modified: {{ jwt_file.stat.mtime | default('N/A') }}"

- name: Check if Reth is currently installed
  ansible.builtin.shell: "{{ reth_binary_path }} --version | awk '{print $2}'"
  register: current_reth_version
  changed_when: false
  failed_when: false

  - name: Get latest Reth release info
  ansible.builtin.uri:
    url: https://api.github.com/repos/paradigmxyz/reth/releases/latest
    method: GET
    return_content: true
  register: reth_release

- name: Register latest Reth version
  ansible.builtin.set_fact:
    reth_latest_version: "{{ reth_release.json.tag_name }}"

  - name: Display version comparison
  ansible.builtin.debug:
    msg:
      - "{{ '=' * 60 }}"
      - "{{ ' ' * 20 }}ğŸš€ RETH VERSION CHECK {{ ' ' * 20 }}"
      - "{{ '=' * 60 }}"
      - "ğŸ“¦ Currently installed: {{ current_reth_version.stdout | default('Not installed') }}"
      - "ğŸ¯ Latest version: {{ reth_latest_version }}"
      - "{{ '=' * 60 }}"